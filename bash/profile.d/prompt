#!/usr/bin/env bash

function main() {
  # shellcheck disable=SC2154
  trap 'echo -ne "${dimgrey}"' DEBUG
}

function __repo() {
  local status branch_name
  ! git rev-parse &> /dev/null && return;
  [ "$( git rev-parse --is-inside-git-dir 2> /dev/null)" == "false" ] && {
    git update-index --really-refresh -q &> /dev/null;
    ! git diff --quiet --ignore-submodules --cached \
      && status+="+";
    ! git diff-files --quiet --ignore-submodules -- \
      && status+="!";
    [ -n "$( git ls-files --others --exclude-standard)" ] \
      && status+="?";
    git rev-parse --verify refs/stash &> /dev/null \
      && status+="⁕";
  }
  branch_name="$( git symbolic-ref --quiet --short HEAD 2> /dev/null || \
    git rev-parse --short HEAD 2> /dev/null || echo "unknown")"
  declare -a git_prompt=(
    "${dimgrey}"    "${1}"           # opening delimeter
    "${bold}${red}" "${branch_name}" # current branch
    "${dimgrey}"    "${2}"           # closing delimeter
    "${green}"      "${status}"      # status symbol
    "${reset}"
  )
  printf %s "${git_prompt[@]}"
}

function __jobs() {
  printf "%d" "$(jobs | wc -l)"
}

function __exit_status() {
# https://www.tldp.org/LDP/abs/html/exitcodes.html
  local last_="$?"
  if [[ "$last_" -ne 0 ]]; then
    if [[ "$last_" -eq 139 ]]; then
      # bring back cursor on SEGFAULT error.
       tput cvvis
    fi
    echo "[$last_]"
  fi
}

function __pwd {
  # shellcheck disable=SC2015
  [[ "${1}" == '~' ]] && printf "home" || basename "$PWD"
}

main && unset -f main
