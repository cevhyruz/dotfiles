#!/usr/bin/env bash
#
# Interactive git commit browser.
# @keys: <enter>  = git show
#         <ctrl-d> = git diff
#         <`>      = toggle sort
#
# shellcheck disable=SC2086

function main() {
  local browser gformat fzf_opts

  gformat="--format=%C(auto)%h%d %s %C(black)%C(green)%cr"
  declare -a fzf_opts=(
    "--query=$(get_query)"
    "--height=100%"
    "--print-query"
    "--expect=ctrl-d"
    "--toggle-sort=\`" )

  while browser=$(git log "${gformat}" | fzf ${fzf_opts[*]}); do
    if [[ "$(get_key)" == "ctrl-d" ]]; then
      # TODO: add option to save to external file (diff.txt)
      gdiff
    else
      gshow
    fi
  done
}

function get_query() {
  head -1 <<< "${browser}"
}

function get_key() {
  head -2 <<< "${browser}" | tail -1
}

function gdiff() {
  local sha
  for sha in $(get_sha); do
    git diff "$sha"
  done
}

function gshow() {
  local sha
  for sha in $(get_sha); do
    git show "${sha}"
  done
}

function get_sha() {
  sed '1,2d;s/^[^a-z0-9]*//;/^$/d' <<< "${browser}" | awk '{print $1}'
}

main
