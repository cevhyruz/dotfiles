#!/usr/bin/env bash
# shellcheck shell=bash disable=SC2207
# vi:ft=sh fdm=marker ts=2 sw=2 et

# Test runner for dotfiles.
#
# Usage:
#   ./test/run [test_file]
#
# Description:
#   Run all test files located in 'test' directory
#   if no [test_file] is supplied.

TEST_DIRECTORY="$(cd "$(dirname "$0")/tests" && pwd)"
TEST_DEPS_DIR="${TEST_DIRECTORY}/../../test_lib"
export TEST_DEPS_DIR
export TEST_DIRECTORY

export BATS_EXECUTABLE="${TEST_DEPS_DIR}/bats-core/bin/bats"

git submodule init && git submodule update

function main() {
  if [[ -z "${1:-}" ]]; then
    readonly TEST_SUITE=("${TEST_DIRECTORY}"/{Bash,install})
  else
    TEST_SUITE=("${1:-}")
  fi

  #echo "${TEST_SUITE[@]}"

  eval "${BATS_EXECUTABLE}" ${CI:+--tap} "${TEST_SUITE[@]}"
}

main "$@"
