#!/usr/bin/env bash
# shellcheck shell=bash disable=SC2207
# vi:ft=sh fdm=marker ts=2 sw=2 et

# Test runner for dotfiles.
#
# Usage:
#   ./test/run [test_file]
#
# Description:
#   Run all test files located in 'test' directory
#   if no [test_file] is supplied.

TEST_DIRECTORY="$(cd "$(dirname "$0")" && pwd)"
TEST_DEPS_DIR="${TEST_DIRECTORY}/../test_lib"
export TEST_DEPS_DIR
export TEST_DIRECTORY

export BATS_EXECUTABLE="${TEST_DIRECTORY}/../test_lib/bats-core/bin/bats"

if [[ -z "${DOTFILES_BASH_DIR:-}" ]]; then
  DOTFILES_BASH_DIR=$(cd "${TEST_DIRECTORY}" && dirname "$(pwd)") &&
    export DOTFILES_BASH_DIR
fi

git submodule init && git submodule update

function main() {
  if [[ -z "${1:-}" ]]; then
    readonly TEST_SUITE=($(find test/tests -type f -name "*.bats"))
  else
    TEST_SUITE=("${1:-}")
  fi

  eval "${BATS_EXECUTABLE} ${CI:+--tap} --recursive" "${TEST_SUITE[@]}"
}

main "$@"
