#!/usr/bin/env bash
# shellcheck shell=bash
# vi:ft=sh fdm=marker ts=2 sw=2 et

# Test runner for dotfiles.
#
# Usage:
#   ./test/run [test_file]
#
# Description:
#   Run all test files located in 'test' directory
#   if no [test_file] is supplied.
#
#   Test files is any of *.bats and/or *.vader files.

set -o privileged
set -o nounset
set -o errexit

TEST_DIRECTORY="$(cd "$(dirname "$0")" && pwd)" &&
  export TEST_DIRECTORY

TEST_DEPS_DIR="${TEST_DIRECTORY}/../test_lib" &&
  export TEST_DEPS_DIR

BATS_EXECUTABLE="${TEST_DIRECTORY}/../test_lib/bats-core/bin/bats"

git submodule init && git submodule update

if [[ -z "${DOTFILES_BASH_DIR:-}" ]]; then
  DOTFILES_BASH_DIR=$(cd "${TEST_DIRECTORY}" && dirname "$(pwd)") &&
    export DOTFILES_BASH_DIR
fi

if [[ $# -eq 0 ]]; then
  # shellcheck disable=2206
  TEST_DIRS=(${TEST_DIRECTORY}/{install,Bash})
  VADER_TEST_DIRS="${TEST_DIRECTORY}/Nvim"
else
  declare -ag BATS_SPEC=()
  declare -ag VADER_SPEC=()

  for spec in "$@"; do
    case "${spec: -5}" in
    '.bats') BATS_SPEC+=("${spec}") ;;
    'vader') VADER_SPEC+=("${spec}") ;;
    esac
  done
fi

export TEMP_DIR="/tmp/dotfiles-vimscript-test"
rm -rf "${TEMP_DIR}"
mkdir -p "${TEMP_DIR}"

cat >"${TEMP_DIR}/mini-vimrc" <<-VIMRC
set runtimepath+=${TEST_DEPS_DIR:0}/vader.vim
set shell=/bin/bash
scriptnames
VIMRC

if [[ -n "${BATS_SPEC[*]:-}" ]] || [[ -n "${TEST_DIRS[*]:-}" ]]; then
  eval "${BATS_EXECUTABLE} ${CI:+--tap} --recursive" \
    "${TEST_DIRS[@]:-${BATS_SPEC[@]}}"
fi

if [[ -n "${VADER_SPEC[*]:-}" ]] || [[ -n "${VADER_TEST_DIRS:-}" ]]; then
  eval "vim -EsNu ${TEMP_DIR}/mini-vimrc -c" \
    "'Vader! ${VADER_SPEC[*]:-${VADER_TEST_DIRS}/*}'" \
    "> /dev/null"
fi
